<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FluxHost File Manager</title>
<meta name="theme-color" content="#120812">
<style>
:root {
  --dusk-deep:     #120812;
  --dusk-mid:      #1e0e24;
  --amber:         #c97b3a;
  --amber-light:   #e8a85c;
  --purple-accent: #9b59b6;
  --purple-glow:   rgba(155,89,182,0.3);
  --text-primary:  rgba(255,255,255,0.93);
  --text-sec:      rgba(255,255,255,0.55);
  --text-dim:      rgba(255,255,255,0.3);
  --r-sm: 8px; --r-md: 12px; --r-lg: 16px;
  --success: #10b981;
  --danger: #ef4444;
  --warning: #f59e0b;
}
body.night-mode {
  --dusk-deep:#000; --dusk-mid:#0a0a0a; --amber:#8b5a2b;
  --amber-light:#a0703a; --purple-accent:#6b3d7d;
  --purple-glow:rgba(107,61,125,0.2);
  --text-primary:rgba(255,255,255,0.95); --text-sec:rgba(255,255,255,0.65); --text-dim:rgba(255,255,255,0.4);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;max-width:100%;}
html{overflow-x:hidden;width:100%;max-width:100vw;touch-action:manipulation;}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  background:var(--dusk-deep);color:var(--text-primary);
  min-height:100vh;-webkit-font-smoothing:antialiased;transition:background 0.4s;
  overflow-x:hidden;width:100%;max-width:100vw;position:relative;
  touch-action:manipulation;
  -webkit-user-select:none;
  -webkit-tap-highlight-color:transparent;
}
.bg-base{
  position:fixed;inset:0;z-index:0;
  background:
    radial-gradient(ellipse 130% 55% at 50% 0%,#2e1640 0%,transparent 65%),
    radial-gradient(ellipse 70% 45% at 15% 75%,#1f1028 0%,transparent 55%),
    radial-gradient(ellipse 85% 35% at 85% 55%,#3a1e45 0%,transparent 50%),
    radial-gradient(ellipse 60% 30% at 50% 95%,#1a0c1e 0%,transparent 60%),
    linear-gradient(180deg,#1c0e25 0%,#130a18 35%,#0d0610 100%);
}
body.night-mode .bg-base{background:#000;}
.bg-glow{
  position:fixed;inset:0;z-index:1;pointer-events:none;
  background:
    radial-gradient(ellipse 65% 22% at 50% 28%,rgba(201,123,58,0.1) 0%,transparent 70%),
    radial-gradient(ellipse 45% 18% at 25% 60%,rgba(155,89,182,0.07) 0%,transparent 55%);
  transition:opacity 0.4s;
}
body.night-mode .bg-glow{opacity:0.3;}

.app{position:relative;z-index:10;width:92%;max-width:1000px;margin:0 auto;padding:16px 0 40px;display:flex;flex-direction:column;gap:10px;}

.glass{
  background:linear-gradient(180deg,rgba(255,255,255,0.11) 0%,rgba(255,255,255,0.045) 18%,rgba(255,255,255,0.035) 80%,rgba(255,255,255,0.06) 100%);
  backdrop-filter:blur(32px) saturate(1.3);-webkit-backdrop-filter:blur(32px) saturate(1.3);
  border:1px solid rgba(255,255,255,0.13);border-top-color:rgba(255,255,255,0.22);
  box-shadow:0 1px 0 inset rgba(255,255,255,0.12),0 6px 28px rgba(0,0,0,0.3),0 1px 2px rgba(0,0,0,0.2);
  border-radius:var(--r-lg);
  transition:background 0.4s,border-color 0.4s;
  overflow:hidden;
}
body.night-mode .glass{
  background:linear-gradient(180deg,rgba(255,255,255,0.06) 0%,rgba(255,255,255,0.02) 18%,rgba(255,255,255,0.015) 80%,rgba(255,255,255,0.03) 100%);
  border:1px solid rgba(255,255,255,0.08);border-top-color:rgba(255,255,255,0.12);
}

.header{display:flex;align-items:center;justify-content:space-between;padding:11px 16px;}
.logo{display:flex;align-items:center;gap:8px;cursor:pointer;}
.logo-svg-wrap{width:28px;height:28px;background:linear-gradient(135deg,var(--purple-accent),#c97b3a);border-radius:7px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px var(--purple-glow);}
.logo-svg-wrap svg{width:16px;height:16px;}
.logo-text{font-size:16px;font-weight:600;letter-spacing:-0.2px;}
.logo-text .b{color:var(--purple-accent);}
.header-right{display:flex;align-items:center;gap:8px;}
.theme-toggle{background:rgba(255,255,255,0.09);border:1px solid rgba(255,255,255,0.13);color:var(--text-sec);width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background 0.2s,transform 0.15s;}
.theme-toggle:hover{background:rgba(255,255,255,0.18);transform:scale(1.05);}
.theme-toggle svg{width:16px;height:16px;fill:currentColor;}

.path-bar{padding:10px 15px;border-bottom:1px solid rgba(255,255,255,0.055);display:flex;align-items:center;gap:8px;}
.path-text{font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;}
.path-value{font-size:12px;color:var(--purple-accent);font-family:'Courier New',monospace;}

.action-grid{padding:12px 15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;}
.action-btn{padding:8px 12px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:var(--r-md);color:var(--text-sec);font-size:11.5px;font-weight:500;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:6px;}
.action-btn:hover{background:rgba(255,255,255,0.08);transform:translateY(-1px);}
.action-btn.primary{background:rgba(155,89,182,0.15);border-color:rgba(155,89,182,0.3);color:var(--purple-accent);}
.action-btn.primary:hover{background:rgba(155,89,182,0.25);}
.action-btn svg{width:12px;height:12px;}

.file-list-wrap{padding:12px 15px;}
.file-list{display:flex;flex-direction:column;gap:4px;}
.file-item{
  background:rgba(255,255,255,0.035);border:1px solid rgba(255,255,255,0.065);
  border-radius:var(--r-md);padding:8px 11px;
  display:flex;align-items:center;gap:10px;
  transition:background 0.22s,border-color 0.22s;
  cursor:pointer;
}
.file-item:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.1);}
.file-item.selected{background:rgba(155,89,182,0.09);border-color:rgba(155,89,182,0.28);}
.file-item.folder-item{border-left:3px solid var(--purple-accent);}
.file-item.folder-item:hover{background:rgba(155,89,182,0.08);}
.file-checkbox{width:16px;height:16px;flex-shrink:0;}
.file-icon{width:18px;height:18px;flex-shrink:0;color:var(--purple-accent);}
.file-icon.file{color:var(--text-sec);width:16px;height:16px;}
.file-name{flex:1;font-size:12px;color:var(--text-primary);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.file-name.folder-name{color:var(--purple-accent);font-weight:500;}
.file-size{font-size:10px;color:var(--text-dim);flex-shrink:0;}
.file-actions{display:flex;gap:4px;flex-shrink:0;}
.file-action-btn{width:24px;height:24px;border-radius:6px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.18s;}
.file-action-btn:hover{background:rgba(255,255,255,0.1);}
.file-action-btn svg{width:11px;height:11px;fill:var(--text-dim);}

.bulk-bar{padding:10px 15px;background:rgba(155,89,182,0.08);border-bottom:1px solid rgba(155,89,182,0.15);display:none;align-items:center;gap:10px;}
.bulk-bar.show{display:flex;}
.bulk-count{font-size:11px;color:var(--purple-accent);flex:1;}
.bulk-actions{display:flex;gap:6px;}
.bulk-btn{padding:5px 10px;border-radius:var(--r-sm);background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:var(--text-sec);font-size:10.5px;cursor:pointer;transition:all 0.2s;}
.bulk-btn:hover{background:rgba(255,255,255,0.08);}
.bulk-btn.danger{background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.3);color:#fca5a5;}
.bulk-btn.danger:hover{background:rgba(239,68,68,0.25);}

.editor-container{position:fixed;inset:0;background:var(--dusk-deep);z-index:1000;display:none;flex-direction:column;}
.editor-container.show{display:flex;}
.editor-header{background:linear-gradient(180deg,rgba(255,255,255,0.11) 0%,rgba(255,255,255,0.045) 100%);backdrop-filter:blur(32px);padding:11px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.08);}
.editor-title{font-size:12px;color:var(--text-sec);font-family:'Courier New',monospace;}
.editor-actions{display:flex;gap:8px;}
.editor-btn{padding:6px 12px;border-radius:var(--r-md);background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:var(--text-sec);font-size:11.5px;font-weight:500;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:6px;}
.editor-btn:hover{background:rgba(255,255,255,0.08);}
.editor-btn.primary{background:rgba(155,89,182,0.15);border-color:rgba(155,89,182,0.3);color:var(--purple-accent);}
.editor-btn.primary:hover{background:rgba(155,89,182,0.25);}
.editor-btn svg{width:12px;height:12px;}

.editor-body{flex:1;display:flex;overflow:hidden;}
.line-numbers{width:50px;background:rgba(0,0,0,0.3);border-right:1px solid rgba(255,255,255,0.08);padding:12px 8px;font-family:'Courier New',Courier,monospace;font-size:12px;color:var(--text-dim);text-align:right;user-select:none;overflow:hidden;line-height:1.6;}
.editor-textarea{flex:1;background:rgba(0,0,0,0.2);border:none;outline:none;padding:12px;font-family:'Courier New',Courier,monospace;font-size:12px;color:var(--text-primary);resize:none;line-height:1.6;overflow-y:auto;-webkit-user-select:text;user-select:text;}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);backdrop-filter:blur(8px);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.show{display:flex;animation:fadeIn 0.2s ease;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

.modal{background:linear-gradient(180deg,rgba(255,255,255,0.11) 0%,rgba(255,255,255,0.045) 100%);backdrop-filter:blur(32px);border:1px solid rgba(255,255,255,0.13);border-radius:var(--r-lg);width:90%;max-width:420px;box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:slideUp 0.3s ease;display:flex;flex-direction:column;}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}

.modal-header{padding:16px 18px;border-bottom:1px solid rgba(255,255,255,0.055);display:flex;align-items:center;justify-content:space-between;}
.modal-title{font-size:14px;font-weight:600;color:var(--text-primary);}
.modal-body{padding:18px;}
.login-logo{text-align:center;margin-bottom:20px;color:var(--purple-accent);font-size:32px;font-weight:700;letter-spacing:-1px;}
.login-logo .flux{background:linear-gradient(135deg,var(--purple-accent),var(--amber));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}

.form-group{margin-bottom:15px;}
.form-group label{display:block;font-size:11px;font-weight:600;color:var(--text-sec);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;}
.form-group input{width:100%;padding:10px 12px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.1);border-radius:var(--r-sm);color:var(--text-primary);font-size:13px;transition:border-color 0.2s;-webkit-user-select:text;user-select:text;}
.form-group input:focus{outline:none;border-color:rgba(155,89,182,0.4);}

.login-btn{width:100%;padding:12px;background:linear-gradient(135deg,var(--purple-accent),var(--amber));border:none;border-radius:var(--r-md);color:white;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;margin-top:10px;}
.login-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 12px var(--purple-glow);}
.login-btn:disabled{opacity:0.5;cursor:not-allowed;}

.error-message{margin-top:12px;padding:10px;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);border-radius:var(--r-sm);color:#fca5a5;font-size:12px;display:none;}
.login-footer{margin-top:20px;text-align:center;font-size:11px;color:var(--text-dim);}

.toast{position:fixed;top:80px;left:50%;transform:translateX(-50%) translateY(-100px);z-index:3000;background:linear-gradient(135deg,rgba(155,89,182,0.95),rgba(201,123,58,0.95));backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.2);border-radius:12px;padding:12px 20px;box-shadow:0 8px 24px rgba(0,0,0,0.4);opacity:0;transition:all 0.4s cubic-bezier(0.34,1.56,0.64,1);pointer-events:none;max-width:90vw;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:all;}
.toast-text{color:white;font-size:13px;font-weight:600;}

.upload-drop{padding:20px;margin:12px 15px;border:2px dashed rgba(255,255,255,0.15);border-radius:var(--r-md);text-align:center;color:var(--text-dim);font-size:12px;transition:all 0.2s;cursor:pointer;}
.upload-drop:hover{border-color:rgba(155,89,182,0.4);color:var(--purple-accent);}
.upload-drop.dragover{border-color:var(--purple-accent);background:rgba(155,89,182,0.08);}
.upload-drop input{display:none;}

/* Syntax highlighting */
.keyword{color:#c678dd;}
.string{color:#98c379;}
.number{color:#d19a66;}
.comment{color:#5c6370;font-style:italic;}
.function{color:#61afef;}
.class{color:#e5c07b;}

@media(max-width:560px){
  .app{width:96%;padding-top:10px;}
  .header{padding:9px 12px;}
  .action-grid{grid-template-columns:1fr 1fr;gap:6px;}
  .bulk-bar{flex-wrap:wrap;}
  .bulk-actions{width:100%;margin-top:8px;}
}
</style>
</head>
<body>
<div class="bg-base"></div>
<div class="bg-glow"></div>

<div class="toast" id="toast">
  <div class="toast-text" id="toast-text">Success</div>
</div>

<div class="modal-overlay" id="login-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Authentication Required</div>
    </div>
    <div class="modal-body">
      <div class="login-logo"><span class="flux">Flux</span>Host</div>
      <p style="text-align:center;color:var(--text-sec);font-size:12px;margin-bottom:20px;">Enter your password to access files</p>
      <form id="login-form" onsubmit="checkPassword(event)">
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Enter your password" required>
        </div>
        <button type="submit" class="login-btn">Login</button>
      </form>
      <div id="error-message" class="error-message"></div>
      <div class="login-footer">
        FluxHost File Manager v2.5.0
        <div style="margin-top:8px;">
          <a href="/" style="color:var(--purple-accent);text-decoration:none;font-size:11px;">‚Üê Back to Terminal</a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="app" id="app" style="display:none;">
  <div class="header glass">
    <div class="logo" onclick="location.href='/'">
      <div class="logo-svg-wrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
      </div>
      <div class="logo-text"><span class="b">Flux</span>Host Files</div>
    </div>
    <div class="header-right">
      <button class="theme-toggle" id="theme-btn" title="Night Mode">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      </button>
      <button class="theme-toggle" onclick="logout()" title="Logout">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>
      </button>
    </div>
  </div>

  <div class="glass">
    <div class="path-bar">
      <span class="path-text">Location:</span>
      <span class="path-value" id="path-display">/</span>
    </div>
    
    <div class="action-grid">
      <button class="action-btn primary" onclick="createNewFile()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        New File
      </button>
      <button class="action-btn primary" onclick="createNewFolder()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
        New Folder
      </button>
      <button class="action-btn" onclick="document.getElementById('upload-input').click()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Upload
      </button>
      <button class="action-btn" onclick="zipSelected()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="9" x2="15" y2="9"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
        Zip
      </button>
      <button class="action-btn" onclick="window.location.href='/'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        Terminal
      </button>
    </div>
    
    <input type="file" id="upload-input" style="display:none" onchange="uploadFile()">
    
    <div class="bulk-bar" id="bulk-bar">
      <div class="bulk-count"><span id="selected-count">0</span> selected</div>
      <div class="bulk-actions">
        <button class="bulk-btn" onclick="selectAllFiles(false)">Deselect</button>
        <button class="bulk-btn danger" onclick="deleteSelected()">Delete</button>
        <button class="bulk-btn" onclick="zipSelected()">Zip</button>
      </div>
    </div>
    
    <div class="file-list-wrap">
      <div class="file-list" id="file-list"></div>
    </div>
  </div>
</div>

<div class="editor-container" id="editor-container">
  <div class="editor-header">
    <div class="editor-title" id="editor-title">Editing: file.txt</div>
    <div class="editor-actions">
      <button class="editor-btn" onclick="closeEditor()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        Close
      </button>
      <button class="editor-btn primary" onclick="saveFile()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/></svg>
        Save
      </button>
    </div>
  </div>
  <div class="editor-body">
    <div class="line-numbers" id="line-numbers">1</div>
    <textarea class="editor-textarea" id="editor-textarea" spellcheck="false"></textarea>
  </div>
</div>

<script>
/* ============================================================ NIGHT MODE ============================================================ */
(function(){
  const btn=document.getElementById('theme-btn');
  if(localStorage.getItem('fluxhost-theme')==='night') document.body.classList.add('night-mode');
  btn.addEventListener('click',function(){ 
    document.body.classList.toggle('night-mode'); 
    localStorage.setItem('fluxhost-theme',document.body.classList.contains('night-mode')?'night':'default'); 
  });
})();

/* ============================================================ AUTH ============================================================ */
const AUTH_TOKEN_KEY = 'fluxhost_auth_token';
const serverUrl = window.location.origin;
let currentPath = "";
let selectedFiles = new Set();
let currentEditingFile = "";

function checkAuthentication() {
  const token = localStorage.getItem(AUTH_TOKEN_KEY);
  if (!token) {
    document.getElementById('login-modal').classList.add('show');
    document.getElementById('app').style.display = 'none';
    return false;
  }
  document.getElementById('app').style.display = 'flex';
  loadFiles();
  return true;
}

async function checkPassword(e) {
  e.preventDefault();
  const password = document.getElementById('password').value;
  const errorMsg = document.getElementById('error-message');
  
  try {
    const res = await fetch('/check-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });
    
    if (res.ok) {
      const token = Math.random().toString(36).substring(2);
      localStorage.setItem(AUTH_TOKEN_KEY, token);
      document.getElementById('login-modal').classList.remove('show');
      document.getElementById('password').value = '';
      errorMsg.style.display = 'none';
      checkAuthentication();
    } else {
      errorMsg.textContent = 'Invalid password';
      errorMsg.style.display = 'block';
    }
  } catch (error) {
    errorMsg.textContent = 'Network error';
    errorMsg.style.display = 'block';
  }
}

function logout() {
  localStorage.removeItem(AUTH_TOKEN_KEY);
  location.reload();
}

/* ============================================================ FILE OPERATIONS ============================================================ */
async function loadFiles(path = "") {
  currentPath = path;
  document.getElementById('path-display').textContent = path || '/';
  selectedFiles.clear();
  updateBulkBar();
  
  const apiUrl = path ? `${serverUrl}/dir/${encodeURIComponent(path)}` : `${serverUrl}/files`;
  
  try {
    const res = await fetch(apiUrl);
    const data = await res.json();
    
    const fileList = document.getElementById('file-list');
    fileList.innerHTML = '';
    
    if (path) {
      fileList.innerHTML += `
        <div class="file-item" onclick="navigateBack()">
          <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          <div class="file-name">.. Go Back</div>
        </div>`;
    }
    
    data.forEach(item => {
      const isFolder = item.is_directory;
      const folderClass = isFolder ? ' folder-item' : '';
      const nameClass = isFolder ? ' folder-name' : '';
      
      const icon = isFolder ? 
        '<svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>' :
        '<svg class="file-icon file" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>';
      
      const size = isFolder ? '<span style="color:var(--purple-accent);font-size:10px;">Folder</span>' : formatSize(item.size);
      
      fileList.innerHTML += `
        <div class="file-item${folderClass}" onclick="handleFileClick('${escapeHtml(item.name)}', ${isFolder})">
          <input type="checkbox" class="file-checkbox" onclick="event.stopPropagation();toggleSelect('${escapeHtml(item.name)}')">
          ${icon}
          <div class="file-name${nameClass}">${escapeHtml(item.name)}</div>
          <div class="file-size">${size}</div>
          <div class="file-actions">
            ${!isFolder ? `<div class="file-action-btn" onclick="event.stopPropagation();downloadFile('${escapeHtml(item.name)}');" title="Download">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            </div>` : ''}
            <div class="file-action-btn" onclick="event.stopPropagation();renameFile('${escapeHtml(item.name)}');" title="Rename">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </div>
            <div class="file-action-btn" onclick="event.stopPropagation();deleteFile('${escapeHtml(item.name)}');" title="Delete">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </div>
          </div>
        </div>`;
    });
  } catch (error) {
    showToast('Error loading files');
  }
}

function handleFileClick(name, isDir) {
  if (isDir) {
    openFolder(name);
  } else {
    openFile(name);
  }
}

function openFolder(name) {
  const newPath = currentPath ? `${currentPath}/${name}` : name;
  loadFiles(newPath);
}

function navigateBack() {
  const parent = currentPath.split("/").slice(0, -1).join("/");
  loadFiles(parent);
}

async function openFile(name) {
  const filePath = currentPath ? `${currentPath}/${name}` : name;
  currentEditingFile = filePath;
  
  if (name.toLowerCase().endsWith('.zip')) {
    if (confirm('Extract this ZIP file?')) {
      try {
        const res = await fetch(`${serverUrl}/unzip`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: filePath, path: currentPath })
        });
        const data = await res.json();
        showToast(data.message || data.error);
        loadFiles(currentPath);
      } catch (error) {
        showToast('Error extracting ZIP');
      }
    }
    return;
  }
  
  try {
    const res = await fetch(`${serverUrl}/files/${encodeURIComponent(filePath)}`);
    const data = await res.json();
    
    document.getElementById('editor-title').textContent = 'Editing: ' + filePath;
    document.getElementById('editor-textarea').value = data.content;
    document.getElementById('editor-container').classList.add('show');
    updateLineNumbers();
    applySyntaxHighlighting();
  } catch (error) {
    showToast('Error opening file');
  }
}

/* ============================================================ SYNTAX HIGHLIGHTING ============================================================ */
function applySyntaxHighlighting() {
  const textarea = document.getElementById('editor-textarea');
  const fileName = currentEditingFile.toLowerCase();
  
  // Detect file type
  let language = 'none';
  if (fileName.endsWith('.py')) language = 'python';
  else if (fileName.endsWith('.js') || fileName.endsWith('.jsx') || fileName.endsWith('.ts') || fileName.endsWith('.tsx')) language = 'javascript';
  else if (fileName.endsWith('.json')) language = 'json';
  else if (fileName.endsWith('.html') || fileName.endsWith('.htm')) language = 'html';
  else if (fileName.endsWith('.css')) language = 'css';
  
  // Add event listener for syntax highlighting as user types
  textarea.removeEventListener('input', handleSyntaxInput);
  textarea.addEventListener('input', handleSyntaxInput);
  
  // Initial highlight
  highlightSyntax(textarea, language);
}

function handleSyntaxInput(e) {
  const textarea = e.target;
  const fileName = currentEditingFile.toLowerCase();
  let language = 'none';
  if (fileName.endsWith('.py')) language = 'python';
  else if (fileName.endsWith('.js') || fileName.endsWith('.jsx') || fileName.endsWith('.ts') || fileName.endsWith('.tsx')) language = 'javascript';
  
  highlightSyntax(textarea, language);
}

function highlightSyntax(textarea, language) {
  // Store cursor position
  const cursorPos = textarea.selectionStart;
  const scrollPos = textarea.scrollTop;
  
  let code = textarea.value;
  
  if (language === 'python') {
    code = highlightPython(code);
  } else if (language === 'javascript') {
    code = highlightJavaScript(code);
  }
  
  // Create or update overlay
  let overlay = document.getElementById('syntax-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'syntax-overlay';
    overlay.style.cssText = `
      position: absolute;
      top: 0;
      left: 50px;
      right: 0;
      bottom: 0;
      padding: 12px;
      font-family: 'Courier New', Courier, monospace;
      font-size: 12px;
      line-height: 1.6;
      color: transparent;
      pointer-events: none;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: hidden;
      z-index: 1;
    `;
    textarea.parentElement.style.position = 'relative';
    textarea.parentElement.insertBefore(overlay, textarea);
    
    // Make textarea transparent but keep caret visible
    textarea.style.color = 'transparent';
    textarea.style.caretColor = '#fff';
    textarea.style.position = 'relative';
    textarea.style.zIndex = '2';
    textarea.style.background = 'transparent';
  }
  
  overlay.innerHTML = code;
  
  // Restore cursor and scroll
  textarea.setSelectionRange(cursorPos, cursorPos);
  textarea.scrollTop = scrollPos;
  overlay.scrollTop = scrollPos;
  
  // Sync scrolling
  textarea.addEventListener('scroll', function() {
    overlay.scrollTop = textarea.scrollTop;
  });
}

function highlightPython(code) {
  // Python keywords
  const keywords = ['def', 'class', 'if', 'elif', 'else', 'for', 'while', 'try', 'except', 'finally', 
                   'import', 'from', 'as', 'return', 'yield', 'lambda', 'with', 'pass', 'break', 
                   'continue', 'and', 'or', 'not', 'in', 'is', 'None', 'True', 'False', 'async', 'await'];
  
  const builtins = ['print', 'input', 'len', 'range', 'str', 'int', 'float', 'list', 'dict', 'set', 
                   'tuple', 'open', 'file', 'type', 'isinstance', 'super', 'self'];
  
  // Escape HTML
  code = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
  
  // Highlight comments
  code = code.replace(/(#.*$)/gm, '<span style="color:#5c6370;font-style:italic;">$1</span>');
  
  // Highlight strings
  code = code.replace(/("[^"]*"|'[^']*'|'''[\s\S]*?'''|"""[\s\S]*?""")/g, '<span style="color:#98c379;">$1</span>');
  
  // Highlight numbers
  code = code.replace(/\b(\d+\.?\d*)\b/g, '<span style="color:#d19a66;">$1</span>');
  
  // Highlight keywords
  keywords.forEach(kw => {
    const regex = new RegExp(`\\b${kw}\\b`, 'g');
    code = code.replace(regex, `<span style="color:#c678dd;">${kw}</span>`);
  });
  
  // Highlight builtins
  builtins.forEach(fn => {
    const regex = new RegExp(`\\b${fn}\\b`, 'g');
    code = code.replace(regex, `<span style="color:#61afef;">${fn}</span>`);
  });
  
  // Highlight function definitions
  code = code.replace(/\b(def)\s+([a-zA-Z_][a-zA-Z0-9_]*)/g, 
    '<span style="color:#c678dd;">$1</span> <span style="color:#e5c07b;">$2</span>');
  
  // Highlight class definitions
  code = code.replace(/\b(class)\s+([a-zA-Z_][a-zA-Z0-9_]*)/g, 
    '<span style="color:#c678dd;">$1</span> <span style="color:#e5c07b;">$2</span>');
  
  return code;
}

function highlightJavaScript(code) {
  // JavaScript keywords
  const keywords = ['const', 'let', 'var', 'function', 'if', 'else', 'for', 'while', 'do', 'switch', 
                   'case', 'default', 'break', 'continue', 'return', 'try', 'catch', 'finally', 
                   'throw', 'new', 'this', 'class', 'extends', 'import', 'export', 'from', 'as', 
                   'async', 'await', 'yield', 'typeof', 'instanceof', 'delete', 'void', 'null', 
                   'undefined', 'true', 'false'];
  
  const builtins = ['console', 'log', 'warn', 'error', 'document', 'window', 'setTimeout', 'setInterval',
                   'parseInt', 'parseFloat', 'isNaN', 'Array', 'Object', 'String', 'Number', 'Boolean',
                   'Math', 'Date', 'JSON', 'Promise', 'fetch'];
  
  // Escape HTML
  code = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
  
  // Highlight comments
  code = code.replace(/(\/\/.*$)/gm, '<span style="color:#5c6370;font-style:italic;">$1</span>');
  code = code.replace(/(\/\*[\s\S]*?\*\/)/g, '<span style="color:#5c6370;font-style:italic;">$1</span>');
  
  // Highlight strings
  code = code.replace(/("[^"]*"|'[^']*'|`[^`]*`)/g, '<span style="color:#98c379;">$1</span>');
  
  // Highlight numbers
  code = code.replace(/\b(\d+\.?\d*)\b/g, '<span style="color:#d19a66;">$1</span>');
  
  // Highlight special keywords with different colors
  code = code.replace(/\b(const)\b/g, '<span style="color:#61afef;">$1</span>');
  code = code.replace(/\b(let)\b/g, '<span style="color:#e5c07b;">$1</span>');
  code = code.replace(/\b(var)\b/g, '<span style="color:#d19a66;">$1</span>');
  code = code.replace(/\b(function)\b/g, '<span style="color:#c678dd;">$1</span>');
  
  // Highlight other keywords
  keywords.forEach(kw => {
    if (!['const', 'let', 'var', 'function'].includes(kw)) {
      const regex = new RegExp(`\\b${kw}\\b`, 'g');
      code = code.replace(regex, `<span style="color:#c678dd;">${kw}</span>`);
    }
  });
  
  // Highlight builtins
  builtins.forEach(fn => {
    const regex = new RegExp(`\\b${fn}\\b`, 'g');
    code = code.replace(regex, `<span style="color:#61afef;">${fn}</span>`);
  });
  
  // Highlight function calls
  code = code.replace(/\b([a-zA-Z_][a-zA-Z0-9_]*)\s*\(/g, '<span style="color:#61afef;">$1</span>(');
  
  return code;
}

async function saveFile() {
  const content = document.getElementById('editor-textarea').value;
  
  try {
    const res = await fetch(`${serverUrl}/edit`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ filename: currentEditingFile, content })
    });
    const data = await res.json();
    showToast(data.message);
  } catch (error) {
    showToast('Error saving file');
  }
}

function closeEditor() {
  const overlay = document.getElementById('syntax-overlay');
  if (overlay) overlay.remove();
  const textarea = document.getElementById('editor-textarea');
  textarea.style.color = 'var(--text-primary)';
  textarea.style.background = 'rgba(0,0,0,0.2)';
  document.getElementById('editor-container').classList.remove('show');
  loadFiles(currentPath);
}

async function createNewFile() {
  const name = prompt('File name:');
  if (!name) return;
  
  const path = currentPath ? `${currentPath}/${name}` : name;
  
  try {
    const res = await fetch(`${serverUrl}/create`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ filename: path })
    });
    const data = await res.json();
    showToast(data.message);
    loadFiles(currentPath);
  } catch (error) {
    showToast('Error creating file');
  }
}

async function createNewFolder() {
  const name = prompt('Folder name:');
  if (!name) return;
  
  const path = currentPath ? `${currentPath}/${name}` : name;
  
  try {
    const res = await fetch(`${serverUrl}/mkdir`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ dirname: path })
    });
    const data = await res.json();
    showToast(data.message);
    loadFiles(currentPath);
  } catch (error) {
    showToast('Error creating folder');
  }
}

async function renameFile(name) {
  const newName = prompt('Rename to:', name);
  if (!newName || newName === name) return;
  
  const oldPath = currentPath ? `${currentPath}/${name}` : name;
  const newPath = currentPath ? `${currentPath}/${newName}` : newName;
  
  try {
    const res = await fetch(`${serverUrl}/rename`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ old_name: oldPath, new_name: newPath })
    });
    const data = await res.json();
    showToast(data.message);
    loadFiles(currentPath);
  } catch (error) {
    showToast('Error renaming file');
  }
}

async function deleteFile(name) {
  if (!confirm(`Delete "${name}"?`)) return;
  
  const path = currentPath ? `${currentPath}/${name}` : name;
  
  try {
    const res = await fetch(`${serverUrl}/delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ filename: path })
    });
    const data = await res.json();
    showToast(data.message);
    loadFiles(currentPath);
  } catch (error) {
    showToast('Error deleting file');
  }
}

async function uploadFile() {
  const input = document.getElementById('upload-input');
  if (!input.files.length) return;
  
  const formData = new FormData();
  formData.append('file', input.files[0]);
  formData.append('path', currentPath);
  
  try {
    const res = await fetch(`${serverUrl}/upload`, {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    showToast(data.message);
    input.value = '';
    loadFiles(currentPath);
  } catch (error) {
    showToast('Error uploading file');
  }
}

function downloadFile(name) {
  const path = currentPath ? `${currentPath}/${name}` : name;
  const url = `${serverUrl}/files/${encodeURIComponent(path)}`;
  
  fetch(url)
    .then(res => res.json())
    .then(data => {
      const blob = new Blob([data.content], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = name;
      link.click();
      showToast('Downloaded ' + name);
    })
    .catch(() => showToast('Error downloading file'));
}

/* ============================================================ SELECTION & BULK ============================================================ */
function toggleSelect(name) {
  if (selectedFiles.has(name)) {
    selectedFiles.delete(name);
  } else {
    selectedFiles.add(name);
  }
  updateBulkBar();
}

function selectAllFiles(select) {
  const checkboxes = document.querySelectorAll('.file-checkbox');
  selectedFiles.clear();
  checkboxes.forEach((cb, i) => {
    if (i > 0) {
      cb.checked = select;
      if (select) {
        const name = cb.parentElement.querySelector('.file-name').textContent;
        selectedFiles.add(name);
      }
    }
  });
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById('bulk-bar');
  const count = document.getElementById('selected-count');
  
  if (selectedFiles.size > 0) {
    bar.classList.add('show');
    count.textContent = selectedFiles.size;
  } else {
    bar.classList.remove('show');
  }
}

async function deleteSelected() {
  if (!selectedFiles.size || !confirm(`Delete ${selectedFiles.size} files?`)) return;
  
  for (const name of selectedFiles) {
    const path = currentPath ? `${currentPath}/${name}` : name;
    await fetch(`${serverUrl}/delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ filename: path })
    }).catch(() => {});
  }
  
  showToast(`Deleted ${selectedFiles.size} files`);
  selectedFiles.clear();
  loadFiles(currentPath);
}

async function zipSelected() {
  if (!selectedFiles.size) {
    showToast('No files selected');
    return;
  }
  
  const zipName = prompt('ZIP file name:', 'archive.zip');
  if (!zipName) return;
  
  // Ensure .zip extension
  const finalZipName = zipName.endsWith('.zip') ? zipName : zipName + '.zip';
  
  try {
    const res = await fetch(`${serverUrl}/create-zip`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        zip_name: finalZipName,
        files: Array.from(selectedFiles),
        path: currentPath
      })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      showToast(data.message);
      selectedFiles.clear();
      loadFiles(currentPath);
    } else {
      showToast(data.error || 'Error creating ZIP');
    }
  } catch (error) {
    showToast('Error creating ZIP file');
  }
}

/* ============================================================ EDITOR ============================================================ */
function updateLineNumbers() {
  const textarea = document.getElementById('editor-textarea');
  const lineNumbers = document.getElementById('line-numbers');
  const lines = textarea.value.split('\n').length;
  
  let html = '';
  for (let i = 1; i <= lines; i++) {
    html += i + '<br>';
  }
  lineNumbers.innerHTML = html;
  
  textarea.addEventListener('scroll', function() {
    lineNumbers.scrollTop = textarea.scrollTop;
  });
}

document.getElementById('editor-textarea')?.addEventListener('input', updateLineNumbers);
document.getElementById('editor-textarea')?.addEventListener('keydown', function(e) {
  if (e.key === 'Tab') {
    e.preventDefault();
    const start = this.selectionStart;
    const end = this.selectionEnd;
    this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
    this.selectionStart = this.selectionEnd = start + 2;
  }
});

/* ============================================================ UTILS ============================================================ */
function showToast(message) {
  const toast = document.getElementById('toast');
  document.getElementById('toast-text').textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

function formatSize(bytes) {
  if (!bytes) return '';
  const kb = bytes / 1024;
  if (kb < 1024) return kb.toFixed(1) + ' KB';
  return (kb / 1024).toFixed(1) + ' MB';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

document.addEventListener('DOMContentLoaded', checkAuthentication);
</script>
</body>
</html>
